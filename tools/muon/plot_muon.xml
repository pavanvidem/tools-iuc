<tool id="plot_muon" name="muon plot" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="@PROFILE@">
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements"/>
    <expand macro="version_command"/>
    <command detect_errors="exit_code"><![CDATA[
@CMD@
        ]]></command>
    <configfiles>
        <configfile name="script_file"><![CDATA[
@CMD_imports@
mdata = mu.read_h5mu('$mudata_input')

#if $method.method == "pl.embedding"
embeddings_plot = mu.pl.embedding(
    mdata,
    @CMD_params_embedding@
    return_fig=True
)

#else if $method.method == "pl.histogram"
plot = mu.pl.histogram(
    mdata,
    #if $method.key_variables.type == "var_names"
        #set $key_list = adata.var_names
    #else if $method.key_variables.type == "obs"
        #set $key_list = adata.obs.select_dtypes(exclude=['category']).columns
    #else if $method.key_variables.type == "custom"
        #set $key_list=([x.strip() for x in str($method.key_variables.keys).split(',')])
    #end if
    keys=$key_list,
    #if $method.groupby
    groupby='$method.groupby',
    #end if
    return_fig=True
)

#else if $method.method == "pl.mofa"
plot = mu.pl.mofa(
    mdata,
    @CMD_params_embedding@
    return_fig=True
)

#else if $method.method == "pl.mofa_loadings"
plot = mu.pl.mofa_loadings(
    mdata,
    #if $method.factors != ''
    factors='$method.factors',
    #end if
    include_lowest='$method.include_lowest',
    #if str($method.n_points) != ''
    n_points=$method.n_points,
    #end if
    return_fig=True
)

#else if $method.method == "pl.scatter"
plot = mu.pl.scatter(
    mdata,
    #if $method.x != ''
    x='$method.x',
    #end if
    #if $method.x != ''
    y='$method.y',
    #end if
    #if $method.color != ''
    color='$method.color',
    #end if
    use_raw='$method.use_raw',
    #if $method.layers != ''
    layers='$method.layers',
    #end if
    return_fig=True
)

#else if $method.method == "pl.umap"
umap_plot = mu.pl.umap(
    mdata,
    @CMD_params_embedding@
    return_fig=True
)

plot.savefig("plot.png")
#end if
]]></configfile>
    </configfiles>
    <inputs>
        <param name="mudata_input" type="data" format="h5mu" label="MuData input for plotting" help="(.h5mu)"/>
        <conditional name="method">
            <param name="method" type="select" label="Method used for plotting">
                    <option value="pl.embedding">Scatter: Scatter plot along observations (.obs column), using 'muon.pl.embedding'</option>
                    <option value="pl.histogram">Histogram: Plot Histogram of Fragment lengths within specified region, using 'muon.pl.histogram'</option>
                    <option value="pl.mofa">Scatter: Scatter plot in MOFA factor coordinates, using 'muon.pl.mofa'</option>
                    <option value="pl.scatter">Scatter: Scatter plot along observations or variable axes, using 'muon.pl.scatter'</option>
                    <option value="pl.umap">Scatter: UMAP scatter plot, using 'muon.pl.umap'</option>
                    <option value="pl.mofa_loadings">Ranking: Rank genes according to contributions to MOFA factors, using 'muon.pl.mofa_loadings'</option>
            </param>
            <when value="pl.embedding">
                <expand macro="params_embedding"/>
            </when>
            <when value="pl.histogram">
                <expand macro="param_keys"/>
                <param argument="group_by" type="text" value="" optional="true" label="Column name(s) of .obs slot of the AnnData object according to which the plot is split"/>
            </when>
            <when value="pl.mofa">
                <expand macro="params_embedding"/>
            </when>
            <when value="pl.mofa_loadings">
                <param argument="factors" type="text" value="" optional="true" label="Comma separated list of factors" help="For example, '1,2,3' means [1, 2, 3], first, second, third factors">
                    <expand macro="sanitize_query" />
                </param>
                <param argument="include_lowest" type="boolean" truevalue="True" falsevalue="False" checked="true" label="Whether to show the variables with both highest and lowest loadings"/>
                <param argument="n_points" type="integer" value="" optional="true" label="Number of variables to plot for each factor"/>
            </when>
            <when value="pl.scatter">
                <param argument="x" type="text" value="" optional="true" label="X-coordinate"/>
                <param argument="y" type="text" value="" optional="true" label="Y-coordinate"/>
                <expand macro="param_color"/>
                <expand macro="param_use_raw" label="Use .raw attribute of the modality where a feature (from color) is derived from." checked="true"/>
                <param argument="layers" type="text" value="" optional="true" label="Names of the layers where x, y, and color come from"/>
            </when>
            <when value="pl.umap">
                <expand macro="params_embedding"/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="plot" format="png" label="Plot" from_work_dir="plot.png"/>
    </outputs>
    <tests>
        <test>
            <!--Test for muon.pl.embedding()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.embedding"/>
            <param name="basis"/>
            <param name="color"/>
            <param name="use_raw"/>
            <param name="layer"/>
            <output name="plot" file="muon.pl.embedding.png"/>
        </test>
        <test>
            <!--Test for muon.pl.mofa()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.mofa"/>
            <output name="plot" file="muon.pl.mofa.png"/>
        </test>
        <test>
            <!--Test for muon.pl.scatter()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.scatter"/>
            <param name="x" value="None"/>
            <param name="y" value="None"/>
            <param name="color" value="None"/>
            <param name="use_raw" value="None"/>
            <param name="layers" value="None"/>
            <output name="plot" file="muon.pl.scatter.png"/>
        </test>
        <test>
            <!--Test for muon.pl.umap()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.umap"/>
            <output name="plot" file="muon.pl.umap.png"/>
        </test>
        <test>
            <!--Test for muon.pl.histogram()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.histogram"/>
            <param name="keys" value="total_counts"/>
            <param name="group_by" value="None"/>
            <output name="plot" file="muon.pl.histogram.png"/>
        </test>
        <test>
            <!--Test for muon.pl.mofa_loadings()-->
            <param name="mudata_input" value="pbmc3k_chr21_processed.h5mu"/>
            <param name="method" value="pl.mofa_loadings"/>
            <param name="factors" value="1"/>
            <param name="include_lowest" value="True"/>
            <param name="n_points" value="0"/>
            <output name="plot" file="muon.pl.mofa_loadings.png"/>
        </test>
    </tests>
    <help><![CDATA[
Scatter: Scatter plot along observations (.obs column) ('muon.pl.embedding')
============================================================================

        Produce a scatter plot in the define basis (.obs), which can also be a basis inside any modality.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.embedding.html#muon.pl.embedding>`__

Scatter: Scatter plot in MOFA factor coordinates ('muon.pl.mofa')
=================================================================

        Scatter plot in MOFA factors coordinates.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.mofa.html#muon.pl.mofa>`__

Scatter: Scatter plot along observations or variable axes ('muon.pl.scatter')
=============================================================================

        Scatter plot along observations or variables axes. Variables in each modality can be referenced.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.scatter.html#muon.pl.scatter>`__

Scatter: UMAP scatter plot ('muon.pl.umap')
===========================================

        UMAP Scatter plot.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.umap.html#muon.pl.umap>`__

Histogram: Plot Histogram of Fragment lengths within specified region ('muon.pl.histogram')
===========================================================================================

        Plot Histogram of Fragment lengths within specified region.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.histogram.html#muon.pl.histogram>`__

Ranking: Rank genes according to contributions to MOFA factors ('muon.pl.mofa_loadings')
========================================================================================

        Rank genes according to contributions to MOFA factors.

        More details on the `muon documentation
        <https://muon.readthedocs.io/en/latest/api/generated/muon.pl.mofa_loadings.html#muon.pl.mofa_loadings>`__
    ]]></help>
    <expand macro="citations"/>
</tool>